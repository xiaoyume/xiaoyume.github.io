<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Iii - xiaoyume&#39;s local blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="xiaoyume" /><meta name="description" content="OpenBLAS矩阵乘法源码结构分析 - 台部落 (twblogs.net) 源码结构 interface 接口层 在OpenBLAS接口层中，运算分为三个类型，分别是level1-3，leve" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://xiaoyume.github.io/post/22.openblas%E7%9A%84gemm%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Iii" />
<meta property="og:description" content="OpenBLAS矩阵乘法源码结构分析 - 台部落 (twblogs.net) 源码结构 interface 接口层 在OpenBLAS接口层中，运算分为三个类型，分别是level1-3，leve" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiaoyume.github.io/post/22.openblas%E7%9A%84gemm%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-10-30T15:44:52+08:00" />
<meta property="article:modified_time" content="2023-10-30T15:44:52+08:00" />
<meta itemprop="name" content="Iii">
<meta itemprop="description" content="OpenBLAS矩阵乘法源码结构分析 - 台部落 (twblogs.net) 源码结构 interface 接口层 在OpenBLAS接口层中，运算分为三个类型，分别是level1-3，leve"><meta itemprop="datePublished" content="2023-10-30T15:44:52+08:00" />
<meta itemprop="dateModified" content="2023-10-30T15:44:52+08:00" />
<meta itemprop="wordCount" content="8503">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Iii"/>
<meta name="twitter:description" content="OpenBLAS矩阵乘法源码结构分析 - 台部落 (twblogs.net) 源码结构 interface 接口层 在OpenBLAS接口层中，运算分为三个类型，分别是level1-3，leve"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">xiaoyume&lt;</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">xiaoyume&lt;</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Iii</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-10-30 </span>
        
          <span class="more-meta"> 约 8503 字 </span>
          <span class="more-meta"> 预计阅读 17 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#源码结构">源码结构</a>
      <ul>
        <li><a href="#interface-接口层">interface 接口层</a>
          <ul>
            <li><a href="#gemmc">gemm.c</a></li>
            <li><a href="#blas_arg_t结构">blas_arg_t结构</a></li>
            <li><a href="#gemmc--namecname">gemm.c&ndash;name/cname</a></li>
            <li><a href="#blas_memory_alloc">blas_memory_alloc</a></li>
            <li><a href="#gotoblas_t">gotoblas_t</a></li>
          </ul>
        </li>
        <li><a href="#核心函数层-kernel层">核心函数层 kernel层</a></li>
      </ul>
    </li>
    <li><a href="#矩阵乘法gmee优化">矩阵乘法GMEE优化</a>
      <ul>
        <li><a href="#最原始的形态-三层for循环">最原始的形态-三层for循环</a></li>
        <li><a href="#第一步优化">第一步优化</a></li>
        <li><a href="#使用寄存器">使用寄存器</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><a href="https://www.twblogs.net/a/5b8df0242b7177188341b127/?lang=zh-cn">OpenBLAS矩阵乘法源码结构分析 - 台部落 (twblogs.net)</a></p>
<h1 id="源码结构">源码结构</h1>
<h2 id="interface-接口层">interface 接口层</h2>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231113101835.png" style="zoom:33%;" />
<p>在OpenBLAS接口层中，运算分为三个类型，分别是level1-3，level3表示矩阵与矩阵之间的运算，低级表示低维度的运算。level1-3都是blas内部使用的接口，对外事不暴露的。</p>
<p>每种源代码文件表示对应的一种操作，这里的gemm指的是普通的矩阵乘。</p>
<h3 id="gemmc">gemm.c</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//后边函数体中要使用的函数指针接口，是计算矩阵乘法的核心函数，有这么多不同的函数指针，是区分了大量特殊情况，如GEMM_NN是两个普通矩阵相乘，而GEMM_TN说明第一个矩阵是转置过的，而带THREAD标签的是多线程实现的核心函数，其执行效率是单核执行的若干倍。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="nf">int</span> <span class="p">(</span><span class="o">*</span><span class="n">gemm</span><span class="p">[])(</span><span class="kt">blas_arg_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span> <span class="o">*</span><span class="p">,</span> <span class="n">FLOAT</span> <span class="o">*</span><span class="p">,</span> <span class="n">FLOAT</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef GEMM3M
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">GEMM_NN</span><span class="p">,</span> <span class="n">GEMM_TN</span><span class="p">,</span> <span class="n">GEMM_RN</span><span class="p">,</span> <span class="n">GEMM_CN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM_NT</span><span class="p">,</span> <span class="n">GEMM_TT</span><span class="p">,</span> <span class="n">GEMM_RT</span><span class="p">,</span> <span class="n">GEMM_CT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM_NR</span><span class="p">,</span> <span class="n">GEMM_TR</span><span class="p">,</span> <span class="n">GEMM_RR</span><span class="p">,</span> <span class="n">GEMM_CR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM_NC</span><span class="p">,</span> <span class="n">GEMM_TC</span><span class="p">,</span> <span class="n">GEMM_RC</span><span class="p">,</span> <span class="n">GEMM_CC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(SMP) &amp;&amp; !defined(USE_SIMPLE_THREADED_LEVEL3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">GEMM_THREAD_NN</span><span class="p">,</span> <span class="n">GEMM_THREAD_TN</span><span class="p">,</span> <span class="n">GEMM_THREAD_RN</span><span class="p">,</span> <span class="n">GEMM_THREAD_CN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM_THREAD_NT</span><span class="p">,</span> <span class="n">GEMM_THREAD_TT</span><span class="p">,</span> <span class="n">GEMM_THREAD_RT</span><span class="p">,</span> <span class="n">GEMM_THREAD_CT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM_THREAD_NR</span><span class="p">,</span> <span class="n">GEMM_THREAD_TR</span><span class="p">,</span> <span class="n">GEMM_THREAD_RR</span><span class="p">,</span> <span class="n">GEMM_THREAD_CR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM_THREAD_NC</span><span class="p">,</span> <span class="n">GEMM_THREAD_TC</span><span class="p">,</span> <span class="n">GEMM_THREAD_RC</span><span class="p">,</span> <span class="n">GEMM_THREAD_CC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">GEMM3M_NN</span><span class="p">,</span> <span class="n">GEMM3M_TN</span><span class="p">,</span> <span class="n">GEMM3M_RN</span><span class="p">,</span> <span class="n">GEMM3M_CN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM3M_NT</span><span class="p">,</span> <span class="n">GEMM3M_TT</span><span class="p">,</span> <span class="n">GEMM3M_RT</span><span class="p">,</span> <span class="n">GEMM3M_CT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM3M_NR</span><span class="p">,</span> <span class="n">GEMM3M_TR</span><span class="p">,</span> <span class="n">GEMM3M_RR</span><span class="p">,</span> <span class="n">GEMM3M_CR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM3M_NC</span><span class="p">,</span> <span class="n">GEMM3M_TC</span><span class="p">,</span> <span class="n">GEMM3M_RC</span><span class="p">,</span> <span class="n">GEMM3M_CC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(SMP) &amp;&amp; !defined(USE_SIMPLE_THREADED_LEVEL3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">GEMM3M_THREAD_NN</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_TN</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_RN</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_CN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM3M_THREAD_NT</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_TT</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_RT</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_CT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM3M_THREAD_NR</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_TR</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_RR</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_CR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GEMM3M_THREAD_NC</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_TC</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_RC</span><span class="p">,</span> <span class="n">GEMM3M_THREAD_CC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//gemm的函数体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">CNAME</span><span class="p">(</span><span class="k">enum</span> <span class="n">CBLAS_ORDER</span> <span class="n">order</span><span class="p">,</span> <span class="k">enum</span> <span class="n">CBLAS_TRANSPOSE</span> <span class="n">TransA</span><span class="p">,</span> <span class="k">enum</span> <span class="n">CBLAS_TRANSPOSE</span> <span class="n">TransB</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">blasint</span> <span class="n">m</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">n</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">k</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="n">FLOAT</span> <span class="n">alpha</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="n">FLOAT</span> <span class="o">*</span><span class="n">alpha</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="n">FLOAT</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">lda</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">FLOAT</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">ldb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="n">FLOAT</span> <span class="n">beta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="n">FLOAT</span> <span class="o">*</span><span class="n">beta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>       <span class="n">FLOAT</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">ldc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//大量代码实现，主要是对输入矩阵格式进行操作，并且选择正确分支，最后调用上边函数表中的一个函数完成运算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="err">。</span>
</span></span><span class="line"><span class="cl">                                <span class="err">。</span>
</span></span><span class="line"><span class="cl">                                <span class="err">。</span>
</span></span><span class="line"><span class="cl">                                <span class="err">。</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//调用函数表中的一个核心计算函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">gemm</span><span class="p">[(</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">])(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="err">｝</span>
</span></span><span class="line"><span class="cl">           
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数的名字是<code>CNAME</code>,而且函数体有大量的ifdef分支，只是因为OpenBLAS采用了类似模板编程的方法，因为大量操作涉及相同的接口结构，所以OpenBLAS使用同一个源代码文件gemm.c来生成各种不同的矩阵乘操作的真正代码文件。在cmake生成工程之后，可以在interface找到一个文件，sgemm.c代码简洁</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define ASMNAME _sgemm
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ASMFNAME _sgemm_
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NAME sgemm_
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CNAME sgemm
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHAR_NAME &#34;sgemm_&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHAR_CNAME &#34;sgemm&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;PATH_TO_YOUR_OPENBLAS/OpenBLAS-develop/interface/gemm.c&#34;</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，这个sgemm的接口define了CNAME，且include了gemm.c，这样gemm.c源代码就会被粘贴进来，而且CNAME会被替换成这个接口真正的名字，形成一个有效的编译单元。同理interface的zgemm,cgemm等都会include上面的gemm.c，生成一个完整的函数实现。这种写法省去了大量的冗余的代码，因为无论是zgemm,sgemm,cgemm等等他们都是矩阵乘，大致实现相同，只是一些细节不同，不需要每个函数都从头写。</p>
<p>c代表复数运算，Z表示双精度运算，s代表单精度</p>
<h3 id="blas_arg_t结构">blas_arg_t结构</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">typedef struct {
</span></span><span class="line"><span class="cl">  void *a, *b, *c, *d, *alpha, *beta;
</span></span><span class="line"><span class="cl">  BLASLONG	m, n, k, lda, ldb, ldc, ldd;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef SMP
</span></span><span class="line"><span class="cl">  void *common;
</span></span><span class="line"><span class="cl">  BLASLONG nthreads;
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef PARAMTEST
</span></span><span class="line"><span class="cl">  BLASLONG gemm_p, gemm_q, gemm_r;
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef PREFETCHTEST
</span></span><span class="line"><span class="cl">  BLASLONG prea, preb, prec, pred;
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">} blas_arg_t;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gemmc--namecname">gemm.c&ndash;name/cname</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">NAME</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">TRANSA</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">TRANSB</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	  <span class="n">blasint</span> <span class="o">*</span><span class="n">M</span><span class="p">,</span> <span class="n">blasint</span> <span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">blasint</span> <span class="o">*</span><span class="n">K</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">alpha</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	  <span class="n">IFLOAT</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">blasint</span> <span class="o">*</span><span class="n">ldA</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	  <span class="n">IFLOAT</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">blasint</span> <span class="o">*</span><span class="n">ldB</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">beta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">blasint</span> <span class="o">*</span><span class="n">ldC</span><span class="p">){</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*char类型的两个参数表示矩阵是否需要转置，&#39;N&#39;表示不转置，&#39;T&#39;表示转置，&#39;C&#39;表示矩阵转置且共轭
</span></span></span><span class="line"><span class="cl"><span class="cm">blasint表示矩阵规模的参数，alpha表示乘法系数，a,b,c表示矩阵，ldA、ldB、ldC表示矩阵leading维度
</span></span></span><span class="line"><span class="cl"><span class="cm">beta表示乘法系数
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="c1">//矩阵运行参数  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">blas_arg_t</span> <span class="n">args</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//是否需要转置，ab行信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">transa</span><span class="p">,</span> <span class="n">transb</span><span class="p">,</span> <span class="n">nrowa</span><span class="p">,</span> <span class="n">nrowb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//可能错误信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">blasint</span> <span class="n">info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">transA</span><span class="p">,</span> <span class="n">transB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//缓存数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">IFLOAT</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//存储转置后的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">IFLOAT</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//多核处理器支持
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#ifdef SMP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">double</span> <span class="n">MNK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//启用简单的多线程level3矩阵运算     没有 禁用亲和性设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined(USE_SIMPLE_THREADED_LEVEL3) || !defined(NO_AFFINITY)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">//不是复数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="mi">0</span><span class="o">--------------------------------</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">//拓展的double
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#ifdef XDOUBLE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_XDOUBLE</span> <span class="o">|</span> <span class="n">BLAS_REAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#elif defined(DOUBLE)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_DOUBLE</span>  <span class="o">|</span> <span class="n">BLAS_REAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_SINGLE</span>  <span class="o">|</span> <span class="n">BLAS_REAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">//复数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#ifdef XDOUBLE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_XDOUBLE</span> <span class="o">|</span> <span class="n">BLAS_COMPLEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#elif defined(DOUBLE)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_DOUBLE</span>  <span class="o">|</span> <span class="n">BLAS_COMPLEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_SINGLE</span>  <span class="o">|</span> <span class="n">BLAS_COMPLEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="mi">0</span><span class="o">-------</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#endif</span><span class="c1">//smP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//多核  线程亲核性 不是简单的level3运算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined(SMP) &amp;&amp; !defined(NO_AFFINITY) &amp;&amp; !defined(USE_SIMPLE_THREADED_LEVEL3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">//定义一个计算节点数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">nodes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">PRINT_DEBUG_NAME</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//矩阵运算相关的参数赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="o">*</span><span class="n">M</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="o">*</span><span class="n">N</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">=</span> <span class="o">*</span><span class="n">K</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">lda</span> <span class="o">=</span> <span class="o">*</span><span class="n">ldA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">ldb</span> <span class="o">=</span> <span class="o">*</span><span class="n">ldB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">ldc</span> <span class="o">=</span> <span class="o">*</span><span class="n">ldC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">alpha</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span><span class="p">.</span><span class="n">beta</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">beta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">transA</span> <span class="o">=</span> <span class="o">*</span><span class="n">TRANSA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">transB</span> <span class="o">=</span> <span class="o">*</span><span class="n">TRANSB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//字符转大写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">TOUPPER</span><span class="p">(</span><span class="n">transA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">TOUPPER</span><span class="p">(</span><span class="n">transB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">transa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">transb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">transA</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//不转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transA</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//转置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transA</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">//实数矩阵转置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transA</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//共轭转置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#else</span><span class="c1">//实数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transA</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transA</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">transB</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">transB</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transB</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">transB</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transB</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">transB</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">nrowa</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">;</span><span class="c1">//初始化nrowa为A行数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transa</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">nrowa</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">;</span><span class="c1">//a是否转置，transa=1 3就可以转置， nrowa更新为A列数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">nrowb</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">;</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">nrowb</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">;</span><span class="c1">//b十分钟转置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ldc</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">)</span> <span class="n">info</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ldb</span> <span class="o">&lt;</span> <span class="n">nrowb</span><span class="p">)</span>  <span class="n">info</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">lda</span> <span class="o">&lt;</span> <span class="n">nrowa</span><span class="p">)</span>  <span class="n">info</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">transa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//都是一些错误情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BLASFUNC</span><span class="p">(</span><span class="n">xerbla</span><span class="p">)(</span><span class="n">ERROR_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ERROR_NAME</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">//cblas_order矩阵顺序，cblas_transpose是否转置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">CNAME</span><span class="p">(</span><span class="k">enum</span> <span class="n">CBLAS_ORDER</span> <span class="n">order</span><span class="p">,</span> <span class="k">enum</span> <span class="n">CBLAS_TRANSPOSE</span> <span class="n">TransA</span><span class="p">,</span> <span class="k">enum</span> <span class="n">CBLAS_TRANSPOSE</span> <span class="n">TransB</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="n">blasint</span> <span class="n">m</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">n</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">k</span><span class="p">,</span><span class="c1">//参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#ifndef COMPLEX</span><span class="c1">//实数，参数赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	   <span class="n">FLOAT</span> <span class="n">alpha</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="n">IFLOAT</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">lda</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="n">IFLOAT</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">ldb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="n">FLOAT</span> <span class="n">beta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="n">FLOAT</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">ldc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	   <span class="kt">void</span> <span class="o">*</span><span class="n">valpha</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">lda</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="kt">void</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">ldb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="kt">void</span> <span class="o">*</span><span class="n">vbeta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	   <span class="kt">void</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">blasint</span> <span class="n">ldc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">FLOAT</span><span class="o">*</span><span class="p">)</span> <span class="n">valpha</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">beta</span>  <span class="o">=</span> <span class="p">(</span><span class="n">FLOAT</span><span class="o">*</span><span class="p">)</span> <span class="n">vbeta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">FLOAT</span><span class="o">*</span><span class="p">)</span> <span class="n">va</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">FLOAT</span><span class="o">*</span><span class="p">)</span> <span class="n">vb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FLOAT</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">FLOAT</span><span class="o">*</span><span class="p">)</span> <span class="n">vc</span><span class="p">;</span>	   
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="kt">blas_arg_t</span> <span class="n">args</span><span class="p">;</span><span class="c1">//矩阵运算的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">transa</span><span class="p">,</span> <span class="n">transb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">blasint</span> <span class="n">nrowa</span><span class="p">,</span> <span class="n">nrowb</span><span class="p">,</span> <span class="n">info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">XFLOAT</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">XFLOAT</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef SMP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">double</span> <span class="n">MNK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(USE_SIMPLE_THREADED_LEVEL3) || !defined(NO_AFFINITY)
</span></span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX </span><span class="c1">//复数类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#ifdef XDOUBLE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_XDOUBLE</span> <span class="o">|</span> <span class="n">BLAS_REAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#elif defined(DOUBLE)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_DOUBLE</span>  <span class="o">|</span> <span class="n">BLAS_REAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_SINGLE</span>  <span class="o">|</span> <span class="n">BLAS_REAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#ifdef XDOUBLE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_XDOUBLE</span> <span class="o">|</span> <span class="n">BLAS_COMPLEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#elif defined(DOUBLE)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_DOUBLE</span>  <span class="o">|</span> <span class="n">BLAS_COMPLEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">mode</span>  <span class="o">=</span>  <span class="n">BLAS_SINGLE</span>  <span class="o">|</span> <span class="n">BLAS_COMPLEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">           <span class="c1">//多核 有线程亲核性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined(SMP) &amp;&amp; !defined(NO_AFFINITY) &amp;&amp; !defined(USE_SIMPLE_THREADED_LEVEL3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kt">int</span> <span class="n">nodes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">PRINT_DEBUG_CNAME</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           <span class="c1">//不是复数 不是double， 不是bfloat16 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if !defined(COMPLEX) &amp;&amp; !defined(DOUBLE) &amp;&amp; !defined(BFLOAT16) &amp;&amp; defined(USE_SGEMM_KERNEL_DIRECT)</span><span class="c1">//直接使用单精度gemm内核
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#ifdef DYNAMIC_ARCH</span><span class="c1">//动态框架支持
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="nf">support_avx512</span><span class="p">()</span> <span class="p">)</span><span class="c1">//支持avx512指令集
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#endif  
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>     <span class="c1">// 行存储模式， 不转置， 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     SGEMM_DIRECT_PERFORMANT()
</span></span></span><span class="line"><span class="cl"><span class="cm">     int sgemm_direct_performant(BLASLONG M, BLASLONG N, BLASLONG K);
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">beta</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alpha</span> <span class="o">==</span> <span class="mf">1.0</span> <span class="o">&amp;&amp;</span> <span class="n">order</span> <span class="o">==</span> <span class="n">CblasRowMajor</span> <span class="o">&amp;&amp;</span> <span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasNoTrans</span> <span class="o">&amp;&amp;</span> <span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasNoTrans</span> <span class="o">&amp;&amp;</span> <span class="nf">SGEMM_DIRECT_PERFORMANT</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">SGEMM_DIRECT</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">lda</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ldb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ldc</span><span class="p">);</span><span class="c1">//使用直接的矩阵乘实现
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">args</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">alpha</span><span class="p">;</span><span class="c1">//获取地址，便于获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">args</span><span class="p">.</span><span class="n">beta</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">beta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">args</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">alpha</span><span class="p">;</span><span class="c1">//复数直接赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">args</span><span class="p">.</span><span class="n">beta</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">beta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">transa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="c1">//初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">transb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">info</span>   <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="n">CblasColMajor</span><span class="p">)</span> <span class="p">{</span><span class="c1">//列主序列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">lda</span> <span class="o">=</span> <span class="n">lda</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">ldb</span> <span class="o">=</span> <span class="n">ldb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">ldc</span> <span class="o">=</span> <span class="n">ldc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasNoTrans</span><span class="p">)</span>     <span class="n">transa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasTrans</span><span class="p">)</span>       <span class="n">transa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transa</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasNoTrans</span><span class="p">)</span>     <span class="n">transb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasTrans</span><span class="p">)</span>       <span class="n">transb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transb</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="n">nrowa</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">;</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">transa</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">nrowa</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">;</span><span class="c1">//如果转置，就赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nrowb</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">nrowb</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">info</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ldc</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">)</span> <span class="n">info</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ldb</span> <span class="o">&lt;</span> <span class="n">nrowb</span><span class="p">)</span>  <span class="n">info</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">lda</span> <span class="o">&lt;</span> <span class="n">nrowa</span><span class="p">)</span>  <span class="n">info</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">transa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="n">CblasRowMajor</span><span class="p">)</span> <span class="p">{</span><span class="c1">//行主序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">lda</span> <span class="o">=</span> <span class="n">ldb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">ldb</span> <span class="o">=</span> <span class="n">lda</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">.</span><span class="n">ldc</span> <span class="o">=</span> <span class="n">ldc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasNoTrans</span><span class="p">)</span>     <span class="n">transa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasTrans</span><span class="p">)</span>       <span class="n">transa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transa</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransB</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transa</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasNoTrans</span><span class="p">)</span>     <span class="n">transb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasTrans</span><span class="p">)</span>       <span class="n">transb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef COMPLEX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjNoTrans</span><span class="p">)</span> <span class="n">transb</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TransA</span> <span class="o">==</span> <span class="n">CblasConjTrans</span><span class="p">)</span>   <span class="n">transb</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="n">nrowa</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">transa</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">nrowa</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nrowb</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">nrowb</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">info</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ldc</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">)</span> <span class="n">info</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">ldb</span> <span class="o">&lt;</span> <span class="n">nrowb</span><span class="p">)</span>  <span class="n">info</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">lda</span> <span class="o">&lt;</span> <span class="n">nrowa</span><span class="p">)</span>  <span class="n">info</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">transa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>        <span class="n">info</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">//info不是-1，error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">BLASFUNC</span><span class="p">(</span><span class="n">xerbla</span><span class="p">)(</span><span class="n">ERROR_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ERROR_NAME</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">           <span class="c1">//linux x86 bfloat16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined(__linux__) &amp;&amp; defined(__x86_64__) &amp;&amp; defined(BFLOAT16)
</span></span></span><span class="line"><span class="cl"><span class="cp">#if defined(DYNAMIC_ARCH)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>           <span class="c1">//amx指令支持 &amp;&amp; openblas_amxtile_permission
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">gotoblas</span><span class="o">-&gt;</span><span class="n">need_amxtile_permission</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="n">openblas_amxtile_permission</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">init_amxtile_permission</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#if !defined(DYNAMIC_ARCH) &amp;&amp; defined(SAPPHIRERAPIDS)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">openblas_amxtile_permission</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">init_amxtile_permission</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif  </span><span class="c1">// defined(__linux__) &amp;&amp; defined(__x86_64__) &amp;&amp; defined(BFLOAT16)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if 0</span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">  fprintf(stderr, &#34;m = %4d  n = %d  k = %d  lda = %4d  ldb = %4d  ldc = %4d\n&#34;,
</span></span></span><span class="line"><span class="cl"><span class="c">	 args.m, args.n, args.k, args.lda, args.ldb, args.ldc);
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">IDEBUG_START</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">FUNCTION_PROFILE_START</span><span class="p">();</span><span class="c1">//性能分析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if USE_SMALL_MATRIX_OPT</span><span class="c1">//小矩阵优化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if !defined(COMPLEX)</span><span class="c1">//常数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="nf">GEMM_SMALL_MATRIX_PERMIT</span><span class="p">(</span><span class="n">transa</span><span class="p">,</span> <span class="n">transb</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">FLOAT</span> <span class="o">*</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">alpha</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">FLOAT</span> <span class="o">*</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">beta</span><span class="p">))){</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">FLOAT</span> <span class="o">*</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="nf">GEMM_SMALL_KERNEL_B0</span><span class="p">((</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">))(</span><span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">lda</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">FLOAT</span> <span class="o">*</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">alpha</span><span class="p">),</span> <span class="n">args</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldb</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">c</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="nf">GEMM_SMALL_KERNEL</span><span class="p">((</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">))(</span><span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">lda</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">FLOAT</span> <span class="o">*</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">alpha</span><span class="p">),</span> <span class="n">args</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldb</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">FLOAT</span> <span class="o">*</span><span class="p">)(</span><span class="n">args</span><span class="p">.</span><span class="n">beta</span><span class="p">),</span> <span class="n">args</span><span class="p">.</span><span class="n">c</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else</span><span class="c1">//复数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="nf">GEMM_SMALL_MATRIX_PERMIT</span><span class="p">(</span><span class="n">transa</span><span class="p">,</span> <span class="n">transb</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span><span class="p">(</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="nf">ZGEMM_SMALL_KERNEL_B0</span><span class="p">((</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">))(</span><span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">lda</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldb</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">c</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="nf">ZGEMM_SMALL_KERNEL</span><span class="p">((</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">))(</span><span class="n">args</span><span class="p">.</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">lda</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldb</span><span class="p">,</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="n">c</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">ldc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">XFLOAT</span> <span class="o">*</span><span class="p">)</span><span class="nf">blas_memory_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//分配内存，0表示level3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">           <span class="c1">//计算矩阵a偏移量赋值给sa
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="n">XFLOAT</span> <span class="o">*</span><span class="p">)((</span><span class="n">BLASLONG</span><span class="p">)</span><span class="n">buffer</span> <span class="o">+</span><span class="n">GEMM_OFFSET_A</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">           <span class="c1">//GEMM_P * GEMM_Q * COMPSIZE * SIZE a矩阵的字节数  这是一个与操作，用于将之前计算的偏移值和对齐值相结合并向下取整，以确保对齐。这样得到的值就是进行对齐后的偏移。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="n">XFLOAT</span> <span class="o">*</span><span class="p">)(((</span><span class="n">BLASLONG</span><span class="p">)</span><span class="n">sa</span> <span class="o">+</span> <span class="p">((</span><span class="n">GEMM_P</span> <span class="o">*</span> <span class="n">GEMM_Q</span> <span class="o">*</span> <span class="n">COMPSIZE</span> <span class="o">*</span> <span class="n">SIZE</span> <span class="o">+</span> <span class="n">GEMM_ALIGN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GEMM_ALIGN</span><span class="p">))</span> <span class="o">+</span> <span class="n">GEMM_OFFSET_B</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef SMP
</span></span></span><span class="line"><span class="cl"><span class="cp">#if defined(USE_SIMPLE_THREADED_LEVEL3) || !defined(NO_AFFINITY)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">transa</span> <span class="o">&lt;&lt;</span> <span class="n">BLAS_TRANSA_SHIFT</span><span class="p">);</span><span class="c1">//左移4位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="n">BLAS_TRANSB_SHIFT</span><span class="p">);</span><span class="c1">//左移8位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">           <span class="c1">//阈值判断，确定使用的线程数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">MNK</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">;</span><span class="c1">//总数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="c1">//65535 * 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">MNK</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">SMP_THRESHOLD_MIN</span>  <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">GEMM_MULTITHREAD_THRESHOLD</span><span class="p">)</span>  <span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">args</span><span class="p">.</span><span class="n">nthreads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="c1">//小于阈值线程设置为1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="n">args</span><span class="p">.</span><span class="n">nthreads</span> <span class="o">=</span> <span class="nf">num_cpu_avail</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="c1">//大于这个值设置为3，因为是小矩阵
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">args</span><span class="p">.</span><span class="n">common</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">nthreads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">gemm</span><span class="p">[(</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">])(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//根据trasb 和transa到数组里选择一个函数进行计算
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef SMP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef USE_SIMPLE_THREADED_LEVEL3
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef NO_AFFINITY
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="n">nodes</span> <span class="o">=</span> <span class="nf">get_num_nodes</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">((</span><span class="n">nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">get_node_equal</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">args</span><span class="p">.</span><span class="n">nthreads</span> <span class="o">/=</span> <span class="n">nodes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">gemm_thread_mn</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">gemm</span><span class="p">[</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">],</span> <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">nodes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="n">gemm</span><span class="p">[</span><span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">])(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">GEMM_THREAD</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">gemm</span><span class="p">[(</span><span class="n">transb</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">transa</span><span class="p">],</span> <span class="n">sa</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">nthreads</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef USE_SIMPLE_THREADED_LEVEL3
</span></span></span><span class="line"><span class="cl"><span class="cp">#ifndef NO_AFFINITY
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef SMP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"> <span class="nf">blas_memory_free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">FUNCTION_PROFILE_END</span><span class="p">(</span><span class="n">COMPSIZE</span> <span class="o">*</span> <span class="n">COMPSIZE</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">+</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">IDEBUG_END</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="blas_memory_alloc">blas_memory_alloc</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">void *blas_memory_alloc(int procpos){
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  int position;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  void *map_address;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  void *(*memoryalloc[])(void *address) = {
</span></span><span class="line"><span class="cl">#ifdef ALLOC_DEVICEDRIVER
</span></span><span class="line"><span class="cl">    alloc_devicedirver,
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">/* Hugetlb implicitly assumes ALLOC_SHM */
</span></span><span class="line"><span class="cl">#ifdef ALLOC_SHM
</span></span><span class="line"><span class="cl">    alloc_shm,
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#if ((defined ALLOC_SHM) &amp;&amp; (defined OS_LINUX  || defined OS_AIX  || defined __sun__  || defined OS_WINDOWS))
</span></span><span class="line"><span class="cl">    alloc_hugetlb,
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#ifdef ALLOC_MMAP
</span></span><span class="line"><span class="cl">    alloc_mmap,
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#ifdef ALLOC_QALLOC
</span></span><span class="line"><span class="cl">    alloc_qalloc,
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#ifdef ALLOC_WINDOWS
</span></span><span class="line"><span class="cl">    alloc_windows,
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#ifdef ALLOC_MALLOC
</span></span><span class="line"><span class="cl">    alloc_malloc,
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">    NULL,
</span></span><span class="line"><span class="cl">  };
</span></span><span class="line"><span class="cl">  void *(**func)(void *address);
</span></span><span class="line"><span class="cl">  struct alloc_t * alloc_info;
</span></span><span class="line"><span class="cl">  struct alloc_t ** alloc_table;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#if defined(SMP) &amp;&amp; !defined(USE_OPENMP)
</span></span><span class="line"><span class="cl">int mi;
</span></span><span class="line"><span class="cl">LOCK_COMMAND(&amp;alloc_lock);
</span></span><span class="line"><span class="cl">mi=memory_initialized;
</span></span><span class="line"><span class="cl">UNLOCK_COMMAND(&amp;alloc_lock);
</span></span><span class="line"><span class="cl">  if (!LIKELY_ONE(mi)) {
</span></span><span class="line"><span class="cl">#else
</span></span><span class="line"><span class="cl">  if (!LIKELY_ONE(memory_initialized)) {
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#if defined(SMP) &amp;&amp; !defined(USE_OPENMP)
</span></span><span class="line"><span class="cl">    /* Only allow a single thread to initialize memory system */
</span></span><span class="line"><span class="cl">    LOCK_COMMAND(&amp;alloc_lock);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (!memory_initialized) {
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">      blas_memory_init();
</span></span><span class="line"><span class="cl">#ifdef DYNAMIC_ARCH
</span></span><span class="line"><span class="cl">      gotoblas_dynamic_init();
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#if defined(SMP) &amp;&amp; defined(OS_LINUX) &amp;&amp; !defined(NO_AFFINITY)
</span></span><span class="line"><span class="cl">      gotoblas_affinity_init();
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef SMP
</span></span><span class="line"><span class="cl">      if (!blas_num_threads) blas_cpu_number = blas_get_cpu_number();
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#if defined(ARCH_X86) || defined(ARCH_X86_64) || defined(ARCH_IA64) || defined(ARCH_MIPS64) || defined(ARCH_ARM64)
</span></span><span class="line"><span class="cl">#ifndef DYNAMIC_ARCH
</span></span><span class="line"><span class="cl">      blas_set_parameter();
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      memory_initialized = 1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#if defined(SMP) &amp;&amp; !defined(USE_OPENMP)
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    UNLOCK_COMMAND(&amp;alloc_lock);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef DEBUG
</span></span><span class="line"><span class="cl">  printf(&#34;Alloc Start ...\n&#34;);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  position = 0;
</span></span><span class="line"><span class="cl">  alloc_table = get_memory_table();
</span></span><span class="line"><span class="cl">  do {
</span></span><span class="line"><span class="cl">      if (!alloc_table[position] || !alloc_table[position]-&gt;used) goto allocation;
</span></span><span class="line"><span class="cl">    position ++;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  } while (position &lt; NUM_BUFFERS);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  goto error;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  allocation :
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef DEBUG
</span></span><span class="line"><span class="cl">  printf(&#34;  Position -&gt; %d\n&#34;, position);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  alloc_info = alloc_table[position];
</span></span><span class="line"><span class="cl">  if (!alloc_info) {
</span></span><span class="line"><span class="cl">    do {
</span></span><span class="line"><span class="cl">#ifdef DEBUG
</span></span><span class="line"><span class="cl">      printf(&#34;Allocation Start : %lx\n&#34;, base_address);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      map_address = (void *)-1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      func = &amp;memoryalloc[0];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      while ((*func != NULL) &amp;&amp; (map_address == (void *) -1)) {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        map_address = (*func)((void *)base_address);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef ALLOC_DEVICEDRIVER
</span></span><span class="line"><span class="cl">        if ((*func ==  alloc_devicedirver) &amp;&amp; (map_address == (void *)-1)) {
</span></span><span class="line"><span class="cl">            fprintf(stderr, &#34;OpenBLAS Warning ... Physically contiguous allocation failed.\n&#34;);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef ALLOC_HUGETLBFILE
</span></span><span class="line"><span class="cl">        if ((*func == alloc_hugetlbfile) &amp;&amp; (map_address == (void *)-1)) {
</span></span><span class="line"><span class="cl">#ifndef OS_WINDOWS
</span></span><span class="line"><span class="cl">            fprintf(stderr, &#34;OpenBLAS Warning ... HugeTLB(File) allocation failed.\n&#34;);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#if (defined ALLOC_SHM) &amp;&amp; (defined OS_LINUX  || defined OS_AIX  || defined __sun__  || defined OS_WINDOWS)
</span></span><span class="line"><span class="cl">        if ((*func == alloc_hugetlb) &amp;&amp; (map_address != (void *)-1)) hugetlb_allocated = 1;
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        func ++;
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef DEBUG
</span></span><span class="line"><span class="cl">      printf(&#34;  Success -&gt; %08lx\n&#34;, map_address);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">      if (((BLASLONG) map_address) == -1) base_address = 0UL;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      if (base_address) base_address += allocation_block_size + FIXED_PAGESIZE;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    } while ((BLASLONG)map_address == -1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    alloc_table[position] = alloc_info = map_address;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef DEBUG
</span></span><span class="line"><span class="cl">    printf(&#34;  Mapping Succeeded. %p(%d)\n&#34;, (void *)alloc_info, position);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifdef DEBUG
</span></span><span class="line"><span class="cl">  printf(&#34;Mapped   : %p  %3d\n\n&#34;, (void *)alloc_info, position);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  alloc_info-&gt;used = 1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  return (void *)(((char *)alloc_info) + sizeof(struct alloc_t));
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> error:
</span></span><span class="line"><span class="cl">  printf(&#34;OpenBLAS : Program will terminate because you tried to allocate too many TLS memory regions.\n&#34;);
</span></span><span class="line"><span class="cl">  printf(&#34;This library was built to support a maximum of %d threads - either rebuild OpenBLAS\n&#34;, NUM_BUFFERS);
</span></span><span class="line"><span class="cl">  printf(&#34;with a larger NUM_THREADS value or set the environment variable OPENBLAS_NUM_THREADS to\n&#34;);
</span></span><span class="line"><span class="cl">  printf(&#34;a sufficiently small number. This error typically occurs when the software that relies on\n&#34;);
</span></span><span class="line"><span class="cl">  printf(&#34;OpenBLAS calls BLAS functions from many threads in parallel, or when your computer has more\n&#34;);
</span></span><span class="line"><span class="cl">  printf(&#34;cpu cores than what OpenBLAS was configured to handle.\n&#34;); 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  return NULL;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gotoblas_t">gotoblas_t</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//这个结构体定义了一系列和运算相关的参数和函数指针。这些参数和指针用于配置和执行矩阵运算的不同方面，包括数据类型转换，矩阵乘，矩阵转置。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">dtb_entries</span><span class="p">;</span><span class="c1">//数据表条目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">switch_ratio</span><span class="p">;</span><span class="c1">//切比率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">offsetA</span><span class="p">,</span> <span class="n">offsetB</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span><span class="c1">//矩阵偏移和对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if BUILD_BFLOAT16 == 1</span><span class="c1">//是否构建包含bfloat16数据类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">sbgemm_p</span><span class="p">,</span> <span class="n">sbgemm_q</span><span class="p">,</span> <span class="n">sbgemm_r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">sbgemm_unroll_m</span><span class="p">,</span> <span class="n">sbgemm_unroll_n</span><span class="p">,</span> <span class="n">sbgemm_unroll_mn</span><span class="p">;</span><span class="c1">//循环展开参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">sbgemm_align_k</span><span class="p">;</span><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">need_amxtile_permission</span><span class="p">;</span>  <span class="c1">// 0 default, 1 for device support amx. amx指令权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//类型转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span>   <span class="p">(</span><span class="o">*</span><span class="n">sbstobf16_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span>    <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span>   <span class="p">(</span><span class="o">*</span><span class="n">sbdtobf16_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">double</span>   <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span>   <span class="p">(</span><span class="o">*</span><span class="n">sbf16tos_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span>    <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span>   <span class="p">(</span><span class="o">*</span><span class="n">dbf16tod_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">double</span>   <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbamax_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbamin_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbmax_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbmin_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">BLASLONG</span> <span class="p">(</span><span class="o">*</span><span class="n">isbamax_k</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">BLASLONG</span> <span class="p">(</span><span class="o">*</span><span class="n">isbamin_k</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">BLASLONG</span> <span class="p">(</span><span class="o">*</span><span class="n">isbmax_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">BLASLONG</span> <span class="p">(</span><span class="o">*</span><span class="n">isbmin_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbnrm2_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbasum_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbsum_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbcopy_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">float</span>  <span class="p">(</span><span class="o">*</span><span class="n">sbdot_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="p">(</span><span class="o">*</span><span class="n">dsbdot_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbrot_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbaxpy_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbscal_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbswap_k</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbgemv_n</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="kt">sbgemv_t</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbger_k</span><span class="p">)</span>  <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbsymv_L</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span>  <span class="kt">float</span>  <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span>  <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span>  <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbsymv_U</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span>  <span class="kt">float</span>  <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span>  <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span>  <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbgemm_kernel</span>   <span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbgemm_beta</span>     <span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbgemm_incopy</span>   <span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbgemm_itcopy</span>   <span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbgemm_oncopy</span>   <span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbgemm_otcopy</span>   <span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">bfloat16</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_kernel_LN</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_kernel_LT</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_kernel_RN</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_kernel_RT</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_iunucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_iunncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_iutucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_iutncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_ilnucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_ilnncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_iltucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_iltncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_ounucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_ounncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_outucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_outncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_olnucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_olnncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_oltucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrsm_oltncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_kernel_RN</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_kernel_RT</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_kernel_LN</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_kernel_LT</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_iunucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_iunncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_iutucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_iutncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_ilnucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_ilnncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_iltucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_iltncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_ounucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_ounncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_outucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_outncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_olnucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_olnncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_oltucopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbtrmm_oltncopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbsymm_iutcopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbsymm_iltcopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbsymm_outcopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sbsymm_oltcopy</span><span class="p">)(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>	 <span class="p">(</span><span class="o">*</span><span class="n">sbneg_tcopy</span><span class="p">)</span>   <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span>    <span class="p">(</span><span class="o">*</span><span class="n">sblaswp_ncopy</span><span class="p">)</span> <span class="p">(</span><span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">,</span> <span class="n">BLASLONG</span><span class="p">,</span> <span class="n">blasint</span> <span class="o">*</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="核心函数层-kernel层">核心函数层 kernel层</h2>
<p>选择最简单的GEMM_NN，两个普通的矩阵乘来看。GEMM__NN这个预编译宏最后指向哪个函数，是和很多其它预编译宏相关的，比如define了complex，表示复数矩阵乘，GEMM_NN就指向qgemm_nn函数，如果是实数矩阵乘法，就会指向sgemm_nn函数。核心函数层依然是模板编程。sgemm_nn的实现代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define NN
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ASMNAME _sgemm_nn
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ASMFNAME _sgemm_nn_
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NAME sgemm_nn_
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CNAME sgemm_nn
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHAR_NAME &#34;sgemm_nn_&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CHAR_CNAME &#34;sgemm_nn&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;PATH_TO_YOUR_OPENBLAS/OpenBLAS-develop/driver/level3/gemm.c&#34;</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>和上边的sgemm.c的代码思路相同，这个源代码中仅仅定义函数的名字，真正的模板源代码在gemm.c中，不过这个是在kernel层的代码。level3下面的gemm.c：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;common.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#undef  TIMING
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef PARAMTEST
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef GEMM_P
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef GEMM_Q
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef GEMM_R
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define GEMM_P  (args -&gt; gemm_p)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GEMM_Q  (args -&gt; gemm_q)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define GEMM_R  (args -&gt; gemm_r)
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if 0</span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">#undef GEMM_P
</span></span></span><span class="line"><span class="cl"><span class="c">#undef GEMM_Q
</span></span></span><span class="line"><span class="cl"><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">#define GEMM_P 504
</span></span></span><span class="line"><span class="cl"><span class="c">#define GEMM_Q 128
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef THREADED_LEVEL3
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;level3_thread.c&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;level3.c&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里使用预编译宏控制了一些变量，而有效代码堆在level3.c中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//这里大量的define比较吓人，但是除去分支控制，主要内容是定义了三种操作（函数），BETA_OPERATION，ICOPY_OPERATION，OCOPY_OPERATION，KERNEL_OPERATION。BETA_OPERATION用于给整个矩阵乘以一个系数，因为gemm计算的是c=alpha*a*b+beta*c，这个BETA_OPERATION就是用于乘以那个beta的。两个COPY函数用于矩阵的拷贝，这个和OpenBLAS的实现算法有关，在算法分析中在详细说明。而KERNEL_OPERATION就是核心函数中的核心函数了，他是真正做乘法和乘累加的地方，整个矩阵乘法就是他算完的了。
</span></span><span class="line"><span class="cl">#ifndef BETA_OPERATION
</span></span><span class="line"><span class="cl">#if !defined(XDOUBLE) || !defined(QUAD_PRECISION)
</span></span><span class="line"><span class="cl">#ifndef COMPLEX
</span></span><span class="line"><span class="cl">#define BETA_OPERATION(M_FROM, M_TO, N_FROM, N_TO, BETA, C, LDC) \
</span></span><span class="line"><span class="cl">    GEMM_BETA((M_TO) - (M_FROM), (N_TO - N_FROM), 0, \
</span></span><span class="line"><span class="cl">          BETA[0], NULL, 0, NULL, 0, \
</span></span><span class="line"><span class="cl">          (FLOAT *)(C) + ((M_FROM) + (N_FROM) * (LDC)) * COMPSIZE, LDC)
</span></span><span class="line"><span class="cl">#else
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifndef ICOPY_OPERATION
</span></span><span class="line"><span class="cl">#if defined(NN) || defined(NT) || defined(NC) || defined(NR) || \
</span></span><span class="line"><span class="cl">    defined(RN) || defined(RT) || defined(RC) || defined(RR)
</span></span><span class="line"><span class="cl">#define ICOPY_OPERATION(M, N, A, LDA, X, Y, BUFFER) GEMM_ITCOPY(M, N, (FLOAT *)(A) + ((Y) + (X) * (LDA)) * COMPSIZE, LDA, BUFFER);
</span></span><span class="line"><span class="cl">#else
</span></span><span class="line"><span class="cl">#define ICOPY_OPERATION(M, N, A, LDA, X, Y, BUFFER) GEMM_INCOPY(M, N, (FLOAT *)(A) + ((X) + (Y) * (LDA)) * COMPSIZE, LDA, BUFFER);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifndef OCOPY_OPERATION
</span></span><span class="line"><span class="cl">#if defined(NN) || defined(TN) || defined(CN) || defined(RN) || \
</span></span><span class="line"><span class="cl">    defined(NR) || defined(TR) || defined(CR) || defined(RR)
</span></span><span class="line"><span class="cl">#define OCOPY_OPERATION(M, N, A, LDA, X, Y, BUFFER) GEMM_ONCOPY(M, N, (FLOAT *)(A) + ((X) + (Y) * (LDA)) * COMPSIZE, LDA, BUFFER);
</span></span><span class="line"><span class="cl">#else
</span></span><span class="line"><span class="cl">#define OCOPY_OPERATION(M, N, A, LDA, X, Y, BUFFER) GEMM_OTCOPY(M, N, (FLOAT *)(A) + ((Y) + (X) * (LDA)) * COMPSIZE, LDA, BUFFER);
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#ifndef KERNEL_OPERATION
</span></span><span class="line"><span class="cl">#if !defined(XDOUBLE) || !defined(QUAD_PRECISION)
</span></span><span class="line"><span class="cl">#ifndef COMPLEX
</span></span><span class="line"><span class="cl">#define KERNEL_OPERATION(M, N, K, ALPHA, SA, SB, C, LDC, X, Y) \
</span></span><span class="line"><span class="cl">    KERNEL_FUNC(M, N, K, ALPHA[0], SA, SB, (FLOAT *)(C) + ((X) + (Y) * LDC) * COMPSIZE, LDC)
</span></span><span class="line"><span class="cl">#else
</span></span><span class="line"><span class="cl">#define KERNEL_OPERATION(M, N, K, ALPHA, SA, SB, C, LDC, X, Y) \
</span></span><span class="line"><span class="cl">    KERNEL_FUNC(M, N, K, ALPHA[0], ALPHA[1], SA, SB, (FLOAT *)(C) + ((X) + (Y) * LDC) * COMPSIZE, LDC)
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#else
</span></span><span class="line"><span class="cl">#define KERNEL_OPERATION(M, N, K, ALPHA, SA, SB, C, LDC, X, Y) \
</span></span><span class="line"><span class="cl">    KERNEL_FUNC(M, N, K, ALPHA, SA, SB, (FLOAT *)(C) + ((X) + (Y) * LDC) * COMPSIZE, LDC)
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">#endif
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">//sgemm_nn的函数体，应该说是所有gemm的模版函数体，负责将矩阵乘法完成
</span></span><span class="line"><span class="cl">int CNAME(blas_arg_t *args, BLASLONG *range_m, BLASLONG *range_n,
</span></span><span class="line"><span class="cl">          XFLOAT *sa, XFLOAT *sb, BLASLONG dummy){
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">//对矩阵c调用beta操作（c=alpha*a*b+beta*c）
</span></span><span class="line"><span class="cl">BETA_OPERATION(m_from, m_to, n_from, n_to, beta, c, ldc);
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">                                。
</span></span><span class="line"><span class="cl">//大量复杂的for循环控制，因为这一篇不详细分析算法细节，这里就简化了，源代码中是多个不同层级for嵌套，用于分片
</span></span><span class="line"><span class="cl">for（。。。。。。）
</span></span><span class="line"><span class="cl">｛
</span></span><span class="line"><span class="cl">    //进行一次矩阵拷贝，大致意义是从两个操作数矩阵之一中切出一小块，而这一小块会被放入L1Cache中反复使用，提高缓存命中率以达到加速效果
</span></span><span class="line"><span class="cl">    ICOPY_OPERATION(min_l, min_i, a, lda, ls, m_from, sa);
</span></span><span class="line"><span class="cl">    //同上
</span></span><span class="line"><span class="cl">    OCOPY_OPERATION(min_l, min_jj, b, ldb, ls, jjs, sb + min_l * (jjs - js) * COMPSIZE * l1stride);
</span></span><span class="line"><span class="cl">    //对切出的小块进行矩阵乘法
</span></span><span class="line"><span class="cl">    KERNEL_OPERATION(min_i, min_jj, min_l, alpha, sa, sb + min_l * (jjs - js)  * COMPSIZE * l1stride, c, ldc, m_from, jjs);
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>可见sgemm_nn已经完成两个不转置矩阵的乘法了，但是sgemm_nn中的BETA_OPETATION,ICOPY_OPERATION,OCOPY_OPERATION,KERNEL_OPERATION这几个关键的热点函数又是怎样实现的呢，模板的思路。</p>
<p>BETA_OPERATION指向sgemm_bata,可以找到sgemm_beta.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#define ASMNAME _sgemm_beta
</span></span><span class="line"><span class="cl">#define ASMFNAME _sgemm_beta_
</span></span><span class="line"><span class="cl">#define NAME sgemm_beta_
</span></span><span class="line"><span class="cl">#define CNAME sgemm_beta
</span></span><span class="line"><span class="cl">#define CHAR_NAME &#34;sgemm_beta_&#34;
</span></span><span class="line"><span class="cl">#define CHAR_CNAME &#34;sgemm_beta&#34;
</span></span><span class="line"><span class="cl">#include &#34;PATH_TO_YOUR_OPENBLAS/OpenBLAS-develop/kernel/x86/../generic/gemm_beta.c&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>就是使用VS编译OpenBLAS时，这三个最核心最热点的OPERATION都是像上边sgemm_beta.c一样，最后是使用c代码实现的，其执行效率非常低，而使用官方推荐mingw或者在其他平台，如arm上使用cmake编译时，这些OPERATION会使用更高效的汇编.S代码实现（这个不是编译器的锅，似乎是makefile方面的问题）。我们可以进入kernel文件夹，发现大量kernel代码：</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231113143924.png" style="zoom:33%;" />
<p>可以看到不同的平台，都有大量的kernel代码，这些代码基本都是平台特定的汇编代码。</p>
<p>对于特定的cpu架构，makefile会控制这些热点函数的实现文件，编译对应的.S文件</p>
<h1 id="矩阵乘法gmee优化">矩阵乘法GMEE优化</h1>
<h2 id="最原始的形态-三层for循环">最原始的形态-三层for循环</h2>
<p>$$
\begin{bmatrix}
1&amp;2&amp;3&amp;4\
5&amp;6&amp;7&amp;8\
9&amp;10&amp;11&amp;12\
\end{bmatrix}
\times
\begin{bmatrix}
1&amp;2&amp;3\
4&amp;5&amp;6\
7&amp;8&amp;9\
10&amp;11&amp;12\
\end{bmatrix}
$$</p>
<p><strong>A * B = C</strong></p>
<p><strong>A mxp</strong></p>
<p><strong>B pxn</strong></p>
<p><strong>C mxn</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//C是一个3x3的矩阵
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span><span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span><span class="c1">//C的行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span><span class="o">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">j</span> <span class="o">++){</span><span class="c1">//C的列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span><span class="o">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">;</span> <span class="n">k</span><span class="o">++){</span><span class="c1">//累加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">C</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">+=</span> <span class="n">A</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">k</span><span class="o">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">[</span><span class="n">k</span><span class="o">][</span><span class="n">j</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="第一步优化">第一步优化</h2>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030162616.png" style="zoom: 50%;" />
<p>把矩阵乘法的顺序调一下，做了一个小分块,把p提到一个函数里，用点乘写出来。每次做一个1*4的结果</p>
<p>调换i,j的次序是因为默认矩阵存储是按行存储的，每一行的元素连续。</p>
<h2 id="使用寄存器">使用寄存器</h2>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030163729.png" style="zoom:50%;" />
<p>A C访存做了优化</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030163958.png" style="zoom:50%;" />
<p>刚才在A,C部分，已经用寄存器做了替换。B访存的坐标每次都要计算出来，B访问每个位置都要计算一次。</p>
<p>使用指针，一开始把对应指针位置指好，每次计算只要指针连续移动，而不是每读一个位置重写算一遍。</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030164307.png" style="zoom:50%;" />
<p>循环展开</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030164414.png" style="zoom: 50%;" />
<p>在1*4的时候，Acache复用，如果块变为4x4，计算是一个方块</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030164604.png" style="zoom:50%;" />
<p>对于规模较小的矩阵，cache范围内，没有什么效果，因为所有的元素都一次加载到cache里。如果规模比较大就有一定的性能提升</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030164806.png" style="zoom:50%;" />
<p>使用simd指令</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030164950.png" style="zoom:50%;" />
<p>上层blocking</p>
<p>k切分和m切分 kc和mc</p>
<p>每次做的事一个小块的矩阵乘，相当于一个子问题</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030165415.png" style="zoom:50%;" />
<p>通过pack之后，下一步AddDot4*4里读的元素就不是从A矩阵读，而是从pack后缓存区的位置读。一个好处是，A矩阵已经预热，放进CPU的cache里了；第二个好处是，你可以看到我在存储的时候，这种连续性的存储，读的时候也是连续性读取，效率会非常高，cache效率也非常高。加上通过pack这一步，对于性能的改善，是非常明显的。</p>
<img src="https://cdn.jsdelivr.net/gh/xiaoyume/bpic@main/img/20231030165700.png" style="zoom:50%;" />
<p>对于矩阵乘法实现的话，packing矩阵是一个非常重要的优化方式。再往后大家会想，对于A来说做了Packing，对于B是不是也能做Packing，同样道理也是可以的，就是把它拷贝到一个连续空间。B部分的Packing操作和A部分类似，也是把它的数据从原始矩阵里读出来，然后放到一个连续空间里，使它的内存访问做连续的访存。当然这部分，因为B访存是个流式的访存，所以在这部分的改进会稍微小一点，相比A只有大概10%左右的提升</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">xiaoyume</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-10-30
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/23.openblas%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Openblas</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/20.%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86mysql/">
            <span class="next-text nav-default">重新认识MySql</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
  <a href="https://xiaoyume.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>xiaoyume</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script></script><script src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js" integrity="sha256-4O4pS1SH31ZqrSO2A/2QJTVjTPqVe+jnYgOWUVr7EEc=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/snapsvg@0.5.1/dist/snap.svg-min.js" integrity="sha256-oI+elz+sIm+jpn8F/qEspKoKveTc5uKeFHNNVexe6d8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/underscore@1.8.3/underscore-min.js" integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.js" integrity="sha384-8748Vn52gHJYJI0XEuPB2QlPVNUkJlJn9tHqKec6J3q2r9l8fvRxrgn/E5ZHV0sP" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.css" integrity="sha384-6QbLKJMz5dS3adWSeINZe74uSydBGFbnzaAYmp+tKyq60S7H2p6V7g1TysM5lAaF" crossorigin="anonymous">



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
